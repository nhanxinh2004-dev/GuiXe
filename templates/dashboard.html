<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Trang Chủ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* Header */
        .app-header { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .logout-btn { color: #dc3545; font-weight: 500; text-decoration: none; font-size: 0.9rem; }
        
        /* Info Card */
        .info-card { background: white; margin: 20px; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .plate-number { font-size: 1.8rem; font-weight: 800; color: #333; letter-spacing: 1px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-block; margin-top: 5px; }
        .st-out { background: #e9ecef; color: #495057; }
        .st-in { background: #d1e7dd; color: #0f5132; }

        /* Action Button Area */
        .action-container { padding: 0 20px; margin-top: 20px; }
        .big-btn { 
            width: 100%; aspect-ratio: 1/1; max-height: 300px; 
            border-radius: 24px; border: none; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            transition: transform 0.1s;
        }
        .big-btn:active { transform: scale(0.98); }
        .big-btn h1 { font-size: 2.5rem; font-weight: 800; margin: 0; }
        .big-btn span { font-size: 1.1rem; opacity: 0.9; margin-top: 5px; }
        
        .btn-in { background: linear-gradient(135deg, #0d6efd, #0a58ca); }
        .btn-out { background: linear-gradient(135deg, #ffc107, #fd7e14); color: #000 !important; }

        /* QR Area */
        #qrArea { background: white; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode img { display: block; margin: 0 auto; }
        .timer-pill { background: #fee2e2; color: #b91c1c; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-top: 15px; }
        
        /* Session Timer Small */
        .sess-timer { font-size: 0.75rem; color: #6c757d; background: #e9ecef; padding: 2px 8px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="app-header">
        <div>
            <div class="fw-bold">{{ user.full_name }}</div>
            <div class="sess-timer">⏳ <span id="sessCount">--:--</span></div>
        </div>
        <a href="/logout" class="logout-btn">Đăng xuất</a>
    </div>

    <div class="info-card text-center">
        <div class="text-muted small text-uppercase">Biển số xe</div>
        <div class="plate-number text-uppercase">{{ user.license_plate }}</div>
        <div class="text-muted small mt-1">{{ user.vehicle_type }}</div>
        
        <div class="mt-2">
            {% if user.status == 0 %}
                <span class="status-badge st-out">● Xe đang ở ngoài</span>
            {% else %}
                <span class="status-badge st-in">● Xe đang trong bãi</span>
            {% endif %}
        </div>
    </div>

    <div class="action-container" id="actionArea">
        {% if user.status == 0 %}
            <button onclick="createQR()" class="big-btn btn-in">
                <h1>GỬI XE</h1>
                <span>Chạm để lấy mã</span>
            </button>
        {% else %}
            <button onclick="createQR()" class="big-btn btn-out">
                <h1>LẤY XE</h1>
                <span>Chạm để lấy mã</span>
            </button>
        {% endif %}
    </div>

    <div id="qrArea" style="display:none;">
        <h2 id="qrTitle" class="fw-bold mb-4"></h2>
        
        <div class="p-3 bg-white border rounded shadow-sm">
            <div id="qrcode"></div>
        </div>

        <div class="timer-pill">Hết hạn sau: <span id="qrCount">05:00</span></div>
        <p class="text-muted mt-3 text-center small">Đưa mã này cho bảo vệ<br>để quét xác nhận.</p>

        <button onclick="location.reload()" class="btn btn-secondary rounded-pill px-4 mt-4">Đóng lại</button>
    </div>

    <script>
        let sessionTimeLeft = parseInt('{{ remaining }}');
        let qrInterval;

        // Xử lý đếm ngược Session Logout
        const sessTimer = setInterval(() => {
            sessionTimeLeft--;
            let m = Math.floor(sessionTimeLeft / 60);
            let s = sessionTimeLeft % 60;
            document.getElementById('sessCount').innerText = `${m}:${s < 10 ? '0'+s : s}`;
            if(sessionTimeLeft <= 0) {
                clearInterval(sessTimer);
                window.location.href = "/logout";
            }
        }, 1000);

        function createQR() {
            fetch('/api/generate_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({}) 
            })
            .then(res => {
                if(res.status === 401) window.location.href = "/login?timeout=1";
                return res.json();
            })
            .then(data => {
                sessionTimeLeft = data.new_timeout; 
                
                document.getElementById('qrArea').style.display = 'flex'; // Dùng flex để căn giữa
                document.getElementById('qrTitle').innerText = data.action_name;
                document.getElementById('qrTitle').className = data.action_name === "GỬI XE" ? "text-primary fw-bold mb-4" : "text-warning fw-bold mb-4";

                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), {
                    text: data.qr_data,
                    width: 260,
                    height: 260
                });

                startQRTimer(300);
            });
        }

        function startQRTimer(duration) {
            let timer = duration;
            clearInterval(qrInterval);
            qrInterval = setInterval(() => {
                let m = Math.floor(timer / 60);
                let s = timer % 60;
                document.getElementById('qrCount').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if (--timer < 0) {
                    clearInterval(qrInterval);
                    location.reload();
                }
            }, 1000);
        }
    </script>
</body>
</html>
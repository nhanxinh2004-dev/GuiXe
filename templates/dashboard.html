<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Trang Chủ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- THÊM THƯ VIỆN SOCKET.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, sans-serif; }
        .app-header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .info-card { background: white; margin: 20px; padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .big-btn { width: 100%; aspect-ratio: 1/1; max-height: 280px; border-radius: 24px; border: none; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: transform 0.1s; }
        .big-btn:active { transform: scale(0.98); }
        .btn-in { background: linear-gradient(135deg, #0d6efd, #0a58ca); }
        .btn-out { background: linear-gradient(135deg, #ffc107, #fd7e14); color: black !important; }
        
        /* QR Overlay */
        #qrArea { background: white; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Loading Overlay khi check trạng thái */
        #successOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(25, 135, 84, 0.95); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center;}
    </style>
</head>
<body>

    <div class="app-header">
        <div class="fw-bold">{{ user.full_name }}</div>
        <a href="/logout" class="text-danger text-decoration-none fw-bold">Thoát</a>
    </div>

    <div class="info-card">
        <h2 class="text-uppercase fw-bold mb-0">{{ user.license_plate }}</h2>
        <div class="text-muted small mb-2">{{ user.vehicle_type }}</div>
        {% if user.status == 0 %}
            <span class="badge bg-secondary">ĐANG Ở NGOÀI</span>
        {% else %}
            <span class="badge bg-success">ĐANG TRONG BÃI</span>
        {% endif %}
    </div>

    <div class="container mt-4">
        {% if user.status == 0 %}
            <button onclick="createQR('IN')" class="big-btn btn-in">
                <h1 class="fw-bold display-1 mb-0">IN</h1>
                <span>GỬI XE</span>
            </button>
        {% else %}
            <button onclick="createQR('OUT')" class="big-btn btn-out">
                <h1 class="fw-bold display-1 mb-0">OUT</h1>
                <span>LẤY XE</span>
            </button>
        {% endif %}
    </div>

    <div id="qrArea" style="display:none;">
        <h3 id="qrTitle" class="fw-bold mb-4">...</h3>
        <div class="p-3 bg-white border rounded shadow-sm">
            <div id="qrcode"></div>
        </div>
        <div class="mt-4 text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Đang chờ bảo vệ quét...</p>
        </div>
        <button onclick="location.reload()" class="btn btn-secondary rounded-pill px-4 mt-4">Đóng lại</button>
    </div>

    <div id="successOverlay">
        <div style="font-size: 5rem;">✅</div>
        <h2>ĐÃ XÁC NHẬN!</h2>
        <p>Hệ thống đang cập nhật...</p>
    </div>

    <script>
        let socket;
        let currentExpectedAction = "";

        // Kết nối Socket ngay khi vào trang
        function initSocket() {
            socket = io(); // Kết nối tới server
            
            // Báo danh với Server: "Tôi là user có CCCD này"
            socket.emit('join_room', { cccd: "{{ user.cccd }}" });

            // LẮNG NGHE SỰ KIỆN: Khi Host xác nhận
            socket.on('confirmation_success', function(data) {
                // Server báo xong -> Hiện màn hình xanh ngay lập tức
                showSuccessAndReload();
            });
        }

        function createQR(actionType) {
            currentExpectedAction = actionType;
            
            fetch('/api/generate_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({}) 
            })
            .then(res => {
                if(res.status === 401) window.location.href = "/login?timeout=1";
                return res.json();
            })
            .then(data => {
                // Hiện QR
                document.getElementById('qrArea').style.display = 'flex';
                document.getElementById('qrTitle').innerText = data.action_name;
                document.getElementById('qrTitle').className = actionType === "IN" ? "text-primary fw-bold mb-4" : "text-warning fw-bold mb-4";
                
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), {
                    text: data.qr_data,
                    width: 260,
                    height: 260
                });

                // Không cần polling nữa, đã dùng socket
            });
        }

        function showSuccessAndReload() {
            document.getElementById('successOverlay').style.display = 'flex';
            // Đợi 1.5 giây cho user sướng rồi reload
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }

        // Chạy socket khi load trang
        window.onload = initSocket;
    </script>
</body>
</html>
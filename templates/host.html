<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>M√°y Qu√©t Host</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; background: black; font-family: sans-serif; overflow: hidden; }
        
        /* Container Camera */
        #reader { width: 100%; height: 100vh; background: black; }
        
        /* 1. M√†n h√¨nh Ch√†o m·ª´ng (Hi·ªán ƒë·∫ßu ti√™n) */
        #welcomeScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }

        /* 2. M√†n h√¨nh Loading (Hi·ªán khi b·∫•m n√∫t) */
        #loadingScreen { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #000; z-index: 10; 
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            flex-direction: column; align-items: center; justify-content: center; 
            color: white;
        }

        /* N√∫t B·∫Øt ƒë·∫ßu to ƒë·∫πp */
        .btn-start {
            width: 200px; height: 200px;
            border-radius: 50%;
            border: 5px solid rgba(255,255,255,0.2);
            background: linear-gradient(145deg, #0d6efd, #0a58ca);
            color: white; font-size: 1.5rem; font-weight: bold;
            box-shadow: 0 0 30px rgba(13, 110, 253, 0.4);
            transition: transform 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .btn-start:active { transform: scale(0.95); }
        
        /* Banner th√¥ng b√°o */
        #notifyBanner {
            position: fixed; top: -100px; left: 0; width: 100%;
            padding: 20px; text-align: center; color: white; font-weight: bold; font-size: 1.2rem;
            z-index: 200; transition: top 0.4s ease-in-out;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .notify-success { background-color: #198754; }
        .notify-error { background-color: #dc3545; }

        /* K·∫øt qu·∫£ (Bottom Sheet) */
        .bottom-sheet {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: white; border-radius: 20px 20px 0 0;
            padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100; display: flex; flex-direction: column; align-items: center;
        }
        .bottom-sheet.show { bottom: 0; }
        
        /* Elements UI */
        .bs-plate { font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; border: 3px solid #000; padding: 5px 25px; border-radius: 8px; margin: 15px 0; background: #ffc107; color: black;}
        .action-label { font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .btn-confirm { width: 100%; padding: 15px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .btn-cancel { width: 100%; padding: 15px; border: none; background: #e9ecef; color: #495057; border-radius: 12px; font-weight: 600; }
    </style>
</head>
<body>

    <div id="welcomeScreen">
        <h3 class="mb-4 text-white-50">H·ªÜ TH·ªêNG GI·ªÆ XE</h3>
        
        <button onclick="userStartScanner()" class="btn-start">
            <div style="font-size: 3rem;">üì∑</div>
            <div class="mt-2">M·ªû M√ÅY</div>
        </button>

        <p class="mt-4 text-muted small">Nh·∫•n n√∫t ƒë·ªÉ k√≠ch ho·∫°t Camera</p>
    </div>

    <div id="loadingScreen">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5 id="loadingText">ƒêang kh·ªüi ƒë·ªông Camera...</h5>
    </div>

    <div id="notifyBanner">Th√¥ng b√°o</div>
    <div id="reader"></div>

    <div id="resultSheet" class="bottom-sheet">
        <div style="width: 50px; height: 5px; background: #dee2e6; border-radius: 10px; margin-bottom: 20px;"></div>
        <div id="actionLabel" class="action-label">...</div>
        <div id="bsPlate" class="bs-plate">...</div>
        <div id="bsName" class="h5 fw-bold mb-1">...</div>
        <div id="bsType" class="text-muted mb-4">...</div>
        <button onclick="confirmScan()" id="btnConfirm" class="btn btn-primary btn-confirm">X√ÅC NH·∫¨N</button>
        <button onclick="closeSheet()" class="btn-cancel">H·ªßy b·ªè</button>
    </div>

    <audio id="beepSound" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

    <script>
        let scanner;
        let currentQR = "";
        let isProcessing = false;

        // H√†m ƒë∆∞·ª£c g·ªçi khi user b·∫•m n√∫t "M·ªû M√ÅY"
        function userStartScanner() {
            // 1. ·∫®n m√†n h√¨nh ch√†o m·ª´ng
            document.getElementById('welcomeScreen').style.display = 'none';
            
            // 2. Hi·ªán m√†n h√¨nh loading
            document.getElementById('loadingScreen').style.display = 'flex';

            // 3. K√≠ch ho·∫°t √¢m thanh (Unlock Audio Context cho iOS/Android)
            const beep = document.getElementById('beepSound');
            beep.play().then(() => {
                beep.pause();
                beep.currentTime = 0;
            }).catch(e => console.log("Audio unlock failed, but ok."));

            // 4. B·∫Øt ƒë·∫ßu g·ªçi Camera
            startScannerLogic();
        }

        function startScannerLogic() {
            if (typeof Html5Qrcode === 'undefined') {
                setTimeout(startScannerLogic, 500); // ƒê·ª£i th∆∞ vi·ªán load
                return;
            }

            scanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            scanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .then(() => {
                // T·∫Øt loading khi cam ƒë√£ l√™n
                document.getElementById('loadingScreen').style.display = 'none';
            })
            .catch(err => {
                document.getElementById('loadingText').innerHTML = 
                    `<span class="text-danger">L·ªói: Kh√¥ng th·ªÉ m·ªü Camera!</span><br><small>${err}</small>
                     <br><button class="btn btn-outline-light btn-sm mt-3" onclick="location.reload()">Th·ª≠ l·∫°i</button>`;
            });
        }

        function onScanSuccess(decodedText) {
            if(isProcessing) return;
            isProcessing = true;
            
            document.getElementById('beepSound').play();
            scanner.pause(); 
            
            fetch('/api/process_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ qr_string: decodedText })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    showNotify(data.error, "error");
                    setTimeout(resetScan, 2000);
                } else {
                    showSheet(data);
                }
            })
            .catch(() => {
                showNotify("L·ªói k·∫øt n·ªëi m·∫°ng!", "error");
                resetScan();
            });
        }

        function showSheet(data) {
            document.getElementById('bsPlate').innerText = data.license_plate;
            document.getElementById('bsName').innerText = data.full_name;
            document.getElementById('bsType').innerText = data.vehicle_type;
            
            const label = document.getElementById('actionLabel');
            const btn = document.getElementById('btnConfirm');
            
            if(data.req_action === "G·ª¨I XE") {
                label.innerText = "Y√äU C·∫¶U: G·ª¨I XE (IN)";
                label.className = "action-label text-success";
                btn.className = "btn btn-success btn-confirm"; 
            } else {
                label.innerText = "Y√äU C·∫¶U: L·∫§Y XE (OUT)";
                label.className = "action-label text-warning";
                btn.className = "btn btn-warning btn-confirm"; 
            }
            
            btn.innerText = "X√ÅC NH·∫¨N";
            btn.disabled = false;
            document.getElementById('resultSheet').classList.add('show');
        }

        function confirmScan() {
            const btn = document.getElementById('btnConfirm');
            btn.innerText = "ƒêang x·ª≠ l√Ω...";
            btn.disabled = true;

            fetch('/api/process_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ qr_string: currentQR, confirm: true })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    showNotify("‚úÖ X√ÅC NH·∫¨N TH√ÄNH C√îNG", "success");
                    closeSheet();
                } else {
                    showNotify("‚ùå " + data.error, "error");
                    closeSheet();
                }
            })
            .catch(() => {
                showNotify("L·ªói k·∫øt n·ªëi!", "error");
                closeSheet();
            });
        }

        function closeSheet() {
            document.getElementById('resultSheet').classList.remove('show');
            setTimeout(resetScan, 500); 
        }

        function resetScan() {
            isProcessing = false;
            scanner.resume();
        }

        function showNotify(msg, type) {
            const banner = document.getElementById('notifyBanner');
            banner.innerText = msg;
            banner.className = type === 'success' ? 'notify-success' : 'notify-error';
            banner.style.top = "0";
            setTimeout(() => { banner.style.top = "-100px"; }, 2500);
        }
    </script>
</body>
</html>

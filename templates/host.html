<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Máy Quét Host</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; background: black; font-family: sans-serif; overflow: hidden; }
        
        /* Camera Container */
        #reader { width: 100%; height: 100vh; background: black; }
        
        /* Màn hình chờ (Hiện ngay lập tức) */
        #loadingScreen { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #111; z-index: 10; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: white; transition: opacity 0.5s;
        }

        /* Banner thông báo */
        #notifyBanner {
            position: fixed; top: -100px; left: 0; width: 100%;
            padding: 20px; text-align: center; color: white; font-weight: bold; font-size: 1.2rem;
            z-index: 200; transition: top 0.4s ease-in-out;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .notify-success { background-color: #198754; }
        .notify-error { background-color: #dc3545; }

        /* Kết quả (Bottom Sheet) */
        .bottom-sheet {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: white; border-radius: 20px 20px 0 0;
            padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100; display: flex; flex-direction: column; align-items: center;
        }
        .bottom-sheet.show { bottom: 0; }
        
        /* Elements */
        .bs-plate { font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; border: 3px solid #000; padding: 5px 25px; border-radius: 8px; margin: 15px 0; background: #ffc107; color: black;}
        .action-label { font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .btn-confirm { width: 100%; padding: 15px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .btn-cancel { width: 100%; padding: 15px; border: none; background: #e9ecef; color: #495057; border-radius: 12px; font-weight: 600; }
    </style>
</head>
<body>

    <div id="loadingScreen">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5 id="loadingText">Đang khởi động Camera...</h5>
    </div>

    <div id="notifyBanner">Thông báo</div>
    <div id="reader"></div>

    <div id="resultSheet" class="bottom-sheet">
        <div style="width: 50px; height: 5px; background: #dee2e6; border-radius: 10px; margin-bottom: 20px;"></div>
        <div id="actionLabel" class="action-label">...</div>
        <div id="bsPlate" class="bs-plate">...</div>
        <div id="bsName" class="h5 fw-bold mb-1">...</div>
        <div id="bsType" class="text-muted mb-4">...</div>
        <button onclick="confirmScan()" id="btnConfirm" class="btn btn-primary btn-confirm">XÁC NHẬN</button>
        <button onclick="closeSheet()" class="btn-cancel">Hủy bỏ</button>
    </div>

    <audio id="beepSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

    <script>
        let scanner;
        let currentQR = "";
        let isProcessing = false;

        // Chỉ bắt đầu chạy script sau khi trang đã load xong HTML
        document.addEventListener("DOMContentLoaded", function() {
            // Delay nhẹ 500ms để trình duyệt vẽ xong UI mượt mà rồi mới bật cam
            setTimeout(startScanner, 500);
        });

        function startScanner() {
            // Kiểm tra thư viện đã tải xong chưa
            if (typeof Html5Qrcode === 'undefined') {
                console.log("Thư viện chưa tải xong, thử lại...");
                setTimeout(startScanner, 500);
                return;
            }

            scanner = new Html5Qrcode("reader");
            
            // Cấu hình tối giản để khởi động nhanh
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                // Bỏ aspectRatio để thư viện tự tính, đỡ lag
            };
            
            scanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .then(() => {
                // Camera chạy OK -> Ẩn màn hình loading
                const loading = document.getElementById('loadingScreen');
                loading.style.opacity = '0';
                setTimeout(() => { loading.style.display = 'none'; }, 500);
            })
            .catch(err => {
                document.getElementById('loadingText').innerHTML = 
                    `<span class="text-danger">Lỗi: Không thể mở Camera!</span><br><small>${err}</small>`;
            });
        }

        function onScanSuccess(decodedText) {
            if(isProcessing) return;
            isProcessing = true;
            
            document.getElementById('beepSound').play().catch(e => {}); // Fix lỗi auto-play trên một số trình duyệt
            scanner.pause(); 
            
            // Gọi API
            fetch('/api/process_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ qr_string: decodedText })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    showNotify(data.error, "error");
                    setTimeout(resetScan, 2000);
                } else {
                    showSheet(data);
                }
            })
            .catch(() => {
                showNotify("Lỗi kết nối mạng!", "error");
                resetScan();
            });
        }

        function showSheet(data) {
            document.getElementById('bsPlate').innerText = data.license_plate;
            document.getElementById('bsName').innerText = data.full_name;
            document.getElementById('bsType').innerText = data.vehicle_type;
            
            const label = document.getElementById('actionLabel');
            const btn = document.getElementById('btnConfirm');
            
            if(data.req_action === "GỬI XE") {
                label.innerText = "YÊU CẦU: GỬI XE (IN)";
                label.className = "action-label text-success";
                btn.className = "btn btn-success btn-confirm"; 
            } else {
                label.innerText = "YÊU CẦU: LẤY XE (OUT)";
                label.className = "action-label text-warning";
                btn.className = "btn btn-warning btn-confirm"; 
            }
            
            btn.innerText = "XÁC NHẬN";
            btn.disabled = false;
            document.getElementById('resultSheet').classList.add('show');
        }

        function confirmScan() {
            const btn = document.getElementById('btnConfirm');
            btn.innerText = "Đang xử lý...";
            btn.disabled = true;

            fetch('/api/process_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ qr_string: currentQR, confirm: true })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    showNotify("✅ XÁC NHẬN THÀNH CÔNG", "success");
                    closeSheet();
                } else {
                    showNotify("❌ " + data.error, "error");
                    closeSheet();
                }
            })
            .catch(() => {
                showNotify("Lỗi gửi dữ liệu!", "error");
                closeSheet();
            });
        }

        function closeSheet() {
            document.getElementById('resultSheet').classList.remove('show');
            setTimeout(resetScan, 500); 
        }

        function resetScan() {
            isProcessing = false;
            scanner.resume();
        }

        function showNotify(msg, type) {
            const banner = document.getElementById('notifyBanner');
            banner.innerText = msg;
            banner.className = type === 'success' ? 'notify-success' : 'notify-error';
            banner.style.top = "0";
            setTimeout(() => { banner.style.top = "-100px"; }, 2500);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Máy Quét Host</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { margin: 0; padding: 0; background: black; font-family: sans-serif; overflow: hidden; }
        
        /* Camera */
        #reader { width: 100%; height: 100vh; object-fit: cover; }
        
        /* Màn hình chờ Camera (Khắc phục lỗi load lâu) */
        #cameraLoading { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 5; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }

        /* Notification Banner (Thay cho Popup Alert) */
        #notifyBanner {
            position: fixed; top: -100px; left: 0; width: 100%;
            padding: 20px; text-align: center; color: white; font-weight: bold; font-size: 1.2rem;
            z-index: 200; transition: top 0.4s ease-in-out;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .notify-success { background-color: #198754; } /* Xanh */
        .notify-error { background-color: #dc3545; }   /* Đỏ */

        /* Bottom Sheet Kết quả */
        .bottom-sheet {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: white; border-radius: 20px 20px 0 0;
            padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100; display: flex; flex-direction: column; align-items: center;
        }
        .bottom-sheet.show { bottom: 0; }
        
        /* Các thành phần UI khác */
        .bs-plate { font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; border: 3px solid #000; padding: 5px 25px; border-radius: 8px; margin: 15px 0; background: #ffc107; color: black;}
        .action-label { font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .btn-confirm { width: 100%; padding: 15px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .btn-cancel { width: 100%; padding: 15px; border: none; background: #e9ecef; color: #495057; border-radius: 12px; font-weight: 600; }
    </style>
</head>
<body>

    <div id="cameraLoading">
        <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4>Đang khởi động Camera...</h4>
        <p class="text-white-50 small">Vui lòng cấp quyền nếu được hỏi</p>
    </div>

    <div id="notifyBanner">Thông báo ở đây</div>

    <div id="reader"></div>

    <div id="resultSheet" class="bottom-sheet">
        <div style="width: 50px; height: 5px; background: #dee2e6; border-radius: 10px; margin-bottom: 20px;"></div>
        
        <div id="actionLabel" class="action-label">...</div>
        <div id="bsPlate" class="bs-plate">...</div>
        <div id="bsName" class="h5 fw-bold mb-1">...</div>
        <div id="bsType" class="text-muted mb-4">...</div>

        <button onclick="confirmScan()" id="btnConfirm" class="btn btn-primary btn-confirm">XÁC NHẬN</button>
        <button onclick="closeSheet()" class="btn-cancel">Hủy bỏ</button>
    </div>

    <audio id="beepSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

    <script>
        let scanner;
        let currentQR = "";
        let isProcessing = false;

        function startScanner() {
            scanner = new Html5Qrcode("reader");
            
            // Cấu hình tối ưu tốc độ: Giảm fps xuống 10, giảm kích thước vùng quét
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: window.innerHeight/window.innerWidth 
            };
            
            // Khởi động camera
            scanner.start({ facingMode: "environment" }, config, (decodedText) => {
                if(isProcessing) return;
                isProcessing = true;
                document.getElementById('beepSound').play();
                scanner.pause(); // Dừng hình ngay để xử lý
                fetchInfo(decodedText);
            })
            .catch(err => {
                console.error("Camera error:", err);
                showNotification("Không thể mở camera. Vui lòng cấp quyền!", "error");
                document.getElementById('cameraLoading').style.display = 'none';
            });
        }

        function fetchInfo(qrString) {
            currentQR = qrString;
            
            fetch('/api/process_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ qr_string: qrString })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    showNotification(data.error, "error");
                    isProcessing = false;
                    scanner.resume();
                } else {
                    showResultSheet(data);
                }
            })
            .catch(err => {
                console.error("API error:", err);
                showNotification("Lỗi kết nối server!", "error");
                isProcessing = false;
                scanner.resume();
            });
        }

        function showResultSheet(data) {
            document.getElementById('actionLabel').textContent = data.req_action;
            document.getElementById('bsPlate').textContent = data.license_plate;
            document.getElementById('bsName').textContent = data.full_name;
            document.getElementById('bsType').textContent = data.vehicle_type;
            
            // Cập nhật màu theo loại hành động
            if(data.req_action.includes("GỬI")) {
                document.getElementById('actionLabel').style.color = "#0d6efd";
            } else {
                document.getElementById('actionLabel').style.color = "#fd7e14";
            }
            
            document.getElementById('resultSheet').classList.add('show');
            document.getElementById('cameraLoading').style.display = 'none';
        }

        function confirmScan() {
            const btn = document.getElementById('btnConfirm');
            btn.textContent = "Đang xử lý...";
            btn.disabled = true;
            
            fetch('/api/process_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    qr_string: currentQR,
                    confirm: true
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    closeSheet();
                    showNotification("Xác nhận thành công!", "success");
                } else {
                    showNotification("Lỗi: " + data.error, "error");
                }
                btn.textContent = "XÁC NHẬN";
                btn.disabled = false;
            })
            .catch(err => {
                console.error("Confirm error:", err);
                showNotification("Lỗi xác nhận!", "error");
                btn.textContent = "XÁC NHẬN";
                btn.disabled = false;
            });
        }

        function closeSheet() {
            document.getElementById('resultSheet').classList.remove('show');
            isProcessing = false;
            setTimeout(() => {
                scanner.resume();
            }, 300);
        }

        function showNotification(message, type) {
            const banner = document.getElementById('notifyBanner');
            banner.textContent = message;
            banner.className = type === "success" ? "notify-success" : "notify-error";
            banner.style.top = "0";
            
            setTimeout(() => {
                banner.style.top = "-100px";
            }, 3000);
        }

        // Khởi động khi DOM sẵn sàng
        window.addEventListener('load', () => {
            setTimeout(startScanner, 1000); // Chờ 1s để hiện hiệu ứng loading
        });
    </script>
</body>
</html>
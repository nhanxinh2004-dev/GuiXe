<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Máy Quét Host</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: black; font-family: sans-serif; }
        
        /* Camera Fullscreen */
        #reader { width: 100%; height: 100vh; object-fit: cover; }
        #reader video { object-fit: cover; width: 100%; height: 100%; }

        /* Bottom Sheet */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .bottom-sheet.active {
            transform: translateY(0);
        }
        
        .sheet-dragger {
            width: 40px;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
            margin: 0 auto 15px;
        }
        
        .plate-display {
            font-size: 2.2rem;
            font-weight: bold;
            text-align: center;
            background: #ffcc00;
            color: #000;
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            text-transform: uppercase;
        }
        
        .status-badge {
            display: block;
            text-align: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-in { background: #d1e7dd; color: #0f5132; }
        .status-out { background: #e9ecef; color: #495057; }
        
        .action-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn-confirm { background: #28a745; border: none; }
        .btn-cancel { background: #dc3545; border: none; }
        
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid #00ff00;
            border-radius: 20px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
        }
        
        .scan-hint {
            position: absolute;
            bottom: 50px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="reader">
        <div class="scan-overlay"></div>
        <div class="scan-hint">Đưa mã QR vào khung để quét</div>
    </div>

    <div id="resultSheet" class="bottom-sheet">
        <div class="sheet-dragger"></div>
        
        <h4 class="text-center mb-3" id="actionTitle">...</h4>
        
        <div class="plate-display" id="plateNumber">...</div>
        
        <div class="text-center mb-3">
            <span id="statusBadge" class="status-badge">...</span>
        </div>
        
        <div class="info-item mb-2">
            <strong>Chủ xe:</strong> <span id="ownerName">...</span>
        </div>
        
        <div class="info-item mb-2">
            <strong>Loại xe:</strong> <span id="vehicleType">...</span>
        </div>
        
        <div class="info-item mb-3">
            <strong>CCCD:</strong> <span id="cccdInfo">...</span>
        </div>
        
        <div class="action-btns">
            <button onclick="cancelScan()" class="btn btn-cancel text-white">Hủy</button>
            <button onclick="confirmScan()" class="btn btn-confirm text-white">Xác nhận</button>
        </div>
    </div>

    <audio id="beepSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

    <script>
        let html5QrcodeScanner;
        let currentQRString = "";

        function startScanner() {
            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                console.error("Lỗi camera", err);
                alert("Không thể mở camera. Vui lòng cấp quyền!");
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('beepSound').play();
            html5QrcodeScanner.pause(); 
            fetchInfo(decodedText);
        }

        function fetchInfo(qrString) {
            currentQRString = qrString;

            fetch('/api/process_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ qr_string: qrString })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    alert(data.error);
                    html5QrcodeScanner.resume();
                } else {
                    showResultSheet(data);
                }
            })
            .catch(err => {
                alert("Lỗi kết nối Server!");
                html5QrcodeScanner.resume();
            });
        }

        function showResultSheet(data) {
            document.getElementById('actionTitle').innerText = data.req_action;
            document.getElementById('plateNumber').innerText = data.license_plate;
            document.getElementById('ownerName').innerText = data.full_name;
            document.getElementById('vehicleType').innerText = data.vehicle_type;
            document.getElementById('cccdInfo').innerText = data.cccd;

            // Set status badge based on action
            const statusBadge = document.getElementById('statusBadge');
            if(data.req_action === "GỬI XE") {
                statusBadge.className = "status-badge status-in";
                statusBadge.innerText = "XE CẦN GỬI";
            } else {
                statusBadge.className = "status-badge status-out";
                statusBadge.innerText = "XE CẦN LẤY";
            }

            document.getElementById('resultSheet').classList.add('active');
        }

        function cancelScan() {
            document.getElementById('resultSheet').classList.remove('active');
            html5QrcodeScanner.resume();
        }

        function confirmScan() {
            fetch('/api/process_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    qr_string: currentQRString,
                    confirm: true
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    alert("✅ THÀNH CÔNG!");
                    location.reload();
                } else {
                    alert("❌ LỖI: " + data.error);
                    cancelScan();
                }
            })
            .catch(err => {
                alert("Lỗi mạng!");
                cancelScan();
            });
        }

        window.onload = startScanner;
    </script>
</body>
</html>